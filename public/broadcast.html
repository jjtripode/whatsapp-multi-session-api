<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Broadcast WhatsApp</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      padding: 20;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
    }
    label {
      font-weight: bold;
      display: block;
      margin-top: 10px;
    }
    textarea, input {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    button {
      margin-top: 15px;
      padding: 10px 20px;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background-color: #218838;
    }
    .result {
      margin-top: 20px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: #f9f9f9;
    }
    .contact-list {
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* 4 columnas */
            gap: 20px; /* Espacio entre los items */
            list-style: none;
            padding: 0;
            margin: 0;
            max-width: 1200px;
            margin: 0 auto;
        }

        .contact-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
            background: #fff;
        }

        .contact-item:hover {
            transform: scale(1.05);
        }

        .contact-item input {
            margin-bottom: 8px;
            transform: scale(1.3);
        }

        .contact-item span {
            display: block;
            font-size: 14px;
            color: #333;
            text-align: center;
            max-width: 120px;
            word-wrap: break-word;
        }

        @media (max-width: 768px) {
            .contact-list {
                grid-template-columns: repeat(2, 1fr); /* 2 columnas en pantallas m치s peque침as */
            }
        }

        @media (max-width: 480px) {
            .contact-list {
                grid-template-columns: 1fr; /* 1 columna en pantallas muy peque침as */
            }
        }
  </style>
</head>
<body>
  <div class="container">
    <h1>Broadcast WhatsApp</h1>
    <form id="broadcastForm">
      <label for="sessionId">Session ID</label>
      <input type="text" id="sessionId" name="sessionId" placeholder="Ingrese el ID de la sesi칩n" required>

      <label for="message">Mensaje</label>
      <textarea id="message" name="message" placeholder="Escribe el mensaje que deseas enviar" rows="5" required></textarea>

      <label for="contactList">Lista de contactos (opcional, separados por comas)</label>
      <h3>Selecciona contactos:</h3>
      <ul id="contact-list" class="contact-list"></ul>
      
      <textarea id="contactList" name="contactList" placeholder="123456789@c.us,987654321@c.us"></textarea>

      <button type="submit">Enviar Broadcast</button>
    </form>

    <div class="result" id="result"></div>
  </div>

  <script>

document.getElementById("sessionId").addEventListener("input", async function () {
    if (this.value.trim().length === 32) { 
            await loadContacts();
        }
    });
async function loadContacts() {
            try {
              const sessionId = "Ver como obtener el sessionID si es por url o se ingresa a mano"
                let response = await fetch('http://localhost:3000/contacts/' + sessionId);
                let contacts = await response.json();
                let contactList = document.getElementById('contact-list');

                contacts.forEach(contact => {
                    let li = document.createElement('li');
                    li.classList.add('contact-item');
                    let checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = contact.id;
                    checkbox.classList.add('contact-checkbox');

                    li.appendChild(checkbox);
                    li.appendChild(document.createTextNode(` ${contact.id} ${contact.name}`));
                    li.addEventListener('click', () => {
                        checkbox.checked = !checkbox.checked;
                    });
                    contactList.appendChild(li);
                });
            } catch (error) {
                console.error('Error al cargar los contactos:', error);
            }
        }

    document.getElementById("broadcastForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      
      const sessionId = document.getElementById("sessionId").value;
      const message = document.getElementById("message").value;

      let selectedContacts = [];
            document.querySelectorAll('.contact-checkbox:checked').forEach(checkbox => {
                selectedContacts.push(checkbox.value);
            });

      const contactList = document.getElementById("contactList").value
        ? document.getElementById("contactList").value.split(",").map(c => c.trim())
        : null;

      const resultDiv = document.getElementById("result");

      try {
        const response = await fetch("/broadcast", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ sessionId, message, contactList }),
        });

        const result = await response.json();

        if (response.ok) {
          resultDiv.innerHTML = `<strong>Success:</strong> ${result.message}`;
          resultDiv.style.color = "green";
        } else {
          resultDiv.innerHTML = `<strong>Error:</strong> ${result.error}`;
          resultDiv.style.color = "red";
        }
      } catch (error) {
        resultDiv.innerHTML = `<strong>Error:</strong> No se pudo enviar el broadcast`;
        resultDiv.style.color = "red";
      }
    });

    loadContacts();
  </script>
</body>
</html>
